"""
Endings 结局模块
"""

def calculate_ending(game):
    # 判断最终纪元
    if 'victory' in game.era_path:
        final_era = 'expansion'
    else:
        final_era = 'bunker'
    
    # 找出最高属性
    sorted_scores = sorted(game.score.items(), key=lambda x: x[1], reverse=True)
    primary = sorted_scores[0][0]
    primary_val = sorted_scores[0][1]
    secondary = sorted_scores[1][0]
    
    # 根据纪元+属性决定结局
    if final_era == 'expansion':
        if primary == 'survival':
            if primary_val >= 40:
                game.ending(19)
            else:
                game.ending(20)
        elif primary == 'technology':
            if primary_val >= 40:
                game.ending(21)
            else:
                game.ending(22)
        elif primary == 'morality':
            game.ending(23)
        elif primary == 'aggression':
            if primary_val >= 40:
                game.ending(24)
            else:
                game.ending(25)
        else:  # unity
            game.ending(26)
    else:  # bunker
        if primary == 'survival':
            if primary_val >= 35:
                game.ending(27)
            else:
                game.ending(28)
        elif primary == 'technology':
            if primary_val >= 35:
                game.ending(29)
            else:
                game.ending(30)
        elif primary == 'morality':
            if primary_val >= 35:
                game.ending(31)
            else:
                game.ending(32)
        elif primary == 'aggression':
            game.ending(33)
        else:  # unity
            if primary_val >= 35:
                game.ending(34)
            else:
                game.ending(35)

def ending(game, num):
    game.clear_buttons()
    # 根据结局编号获取文本
    ending_texts = {
        19: """═══════════════════════════════════════
扩张结局：永恒的生存者
═══════════════════════════════════════

你选择了生存至上的道路。

人类文明成为了宇宙中最顽强的生存者。
无论面对多强大的敌人，人类总能找到生存的方法。

殖民地遍布银河系。
即使某些星系被摧毁，人类文明也能延续。

但代价是——人类失去了很多东西。
道德、文化、甚至人性本身。

这是一个生存的文明，但还是"人类"吗？

【成就解锁：终极生存者】""",
        20: """═══════════════════════════════════════
扩张结局：流浪的种族
═══════════════════════════════════════

你选择了生存，但保留了人性。

人类成为了宇宙中的流浪者。
不断迁徙，不断适应，但始终保持着人类的本质。

这是一个艰难的道路。
但人类证明了：生存不一定要放弃一切。

【成就解锁：星际流浪者】""",
        21: """═══════════════════════════════════════
扩张结局：技术奇点
═══════════════════════════════════════

你选择了技术至上的道路。

人类的科技达到了难以想象的高度。
掌握了维度技术、时间技术、甚至宇宙规律的修改。

人类成为了宇宙中的"神级文明"。

但在技术的巅峰，人类发现：
宇宙本身可能只是一个更高维度的实验。

【成就解锁：技术之神】""",
        22: """═══════════════════════════════════════
扩张结局：科技文明
═══════════════════════════════════════

你选择了科技发展的道路。

人类成为了一个高度发达的科技文明。
虽然不是最强大的，但在银河系中占有一席之地。

这是一个平衡的结局。
人类既保持了发展，也保留了人性。

【成就解锁：科技文明】""",
        23: """═══════════════════════════════════════
扩张结局：道德灯塔
═══════════════════════════════════════

你选择了道德至上的道路。

人类成为了宇宙中的道德灯塔。
即使在黑暗森林中，也坚持着文明的底线。

许多文明被人类的精神所感动。
一个以道德为基础的宇宙联盟逐渐形成。

这是一个理想主义的结局。
但也许，理想本身就是最大的力量。

【成就解锁：文明之光】""",
        24: """═══════════════════════════════════════
扩张结局：银河霸主
═══════════════════════════════════════

你选择了征服的道路。

人类成为了银河系的霸主。
强大的军事力量让所有文明臣服。

人类建立了一个庞大的帝国。
地球成为了银河系的首都。

但在征服的顶点，你是否想过：
人类会成为下一个被黑暗森林打击的目标吗？

【成就解锁：银河帝国】""",
        25: """═══════════════════════════════════════
扩张结局：战争机器
═══════════════════════════════════════

你选择了军事扩张的道路。

人类成为了一个战争机器。
不断征服，不断扩张。

但在无尽的战争中，
人类逐渐失去了和平的能力。

这是一个悲剧的结局。
人类赢得了战争，却失去了自己。

【成就解锁：永恒战争】""",
        26: """═══════════════════════════════════════
扩张结局：宇宙联邦
═══════════════════════════════════════

你选择了团结的道路。

人类成为了宇宙联邦的核心。
不同的文明在人类的组织下团结起来。

这是一个理想的结局。
宇宙不再是黑暗森林，而是一个大家庭。

但这个联邦能持续多久？
当面对更强大的威胁时，团结还能维持吗？

【成就解锁：宇宙联邦】""",
        27: """═══════════════════════════════════════
掩体结局：最后的幸存者
═══════════════════════════════════════

二向箔降临。
太阳系坍缩为二维。

但你活了下来。

作为少数逃离的人类之一，
你见证了文明的终结。

在逃亡的飞船上，
你带着人类文明的记忆，
飞向未知的星空。

这是一个悲壮的结局。
人类文明几乎全灭，但火种还在。

【成就解锁：文明火种】""",
        28: """═══════════════════════════════════════
掩体结局：二维的永恒
═══════════════════════════════════════

你选择留在太阳系。

当二向箔降临时，
你和整个太阳系一起，
被压缩成二维的画面。

在二维世界中，
太阳系成为了一幅永恒的画。
美丽，但已经死去。

这是一个悲剧的结局。
人类文明随太阳系一起终结。

【成就解锁：二维纪念碑】""",
        29: """═══════════════════════════════════════
掩体结局：技术的遗产
═══════════════════════════════════════

在最后时刻，
你将人类的所有技术和知识，
压缩进一个信息包，
发送向宇宙深处。

也许有一天，
某个文明会发现这个信息包，
了解曾经有一个叫"人类"的文明。

这是一个悲伤但不绝望的结局。
人类的智慧将在宇宙中永存。

【成就解锁：知识遗产】""",
        30: """═══════════════════════════════════════
掩体结局：科技的局限
═══════════════════════════════════════

人类的科技无法对抗降维打击。

所有的掩体，所有的防御，
在二向箔面前都毫无意义。

这是一个残酷的教训：
科技不是万能的。

人类文明终结了。

【成就解锁：技术的终点】""",
        31: """═══════════════════════════════════════
掩体结局：人性的光辉
═══════════════════════════════════════

在最后的时刻，
人类展现了最美好的一面。

没有恐慌，没有混乱。
人们互相安慰，互相拥抱。

程心和艾AA在"星环"号上，
看着太阳系坍缩成二维。

她们带着人类最美好的记忆，
飞向星空。

这是一个悲伤但温暖的结局。
人类文明虽然终结，但人性永存。

【成就解锁：人性之光】""",
        32: """═══════════════════════════════════════
掩体结局：道德的代价
═══════════════════════════════════════

人类坚持了道德，
拒绝建造光速飞船。

因为光速飞船的航迹，
会暴露地球的坐标。

但最终，坐标还是被暴露了。
道德没能拯救人类。

这是一个讽刺的结局。
善良的选择，导致了毁灭的结果。

【成就解锁：道德困境】""",
        33: """═══════════════════════════════════════
掩体结局：无用的反抗
═══════════════════════════════════════

你选择了战斗。

人类向二向箔发射了所有武器。
核弹、反物质弹、甚至引力波...

但一切都是徒劳的。

二向箔不可阻挡。
太阳系坍缩为二维。

这是一个悲壮的结局。
人类战斗到了最后一刻。

【成就解锁：最后的战斗】""",
        34: """═══════════════════════════════════════
掩体结局：团结的奇迹
═══════════════════════════════════════

在最后时刻，
全人类团结起来。

所有的飞船，所有的资源，
都用来拯救尽可能多的人。

虽然大部分人类还是死去了，
但数百万人成功逃离。

他们将在宇宙中重建人类文明。

这是一个悲伤但充满希望的结局。
团结创造了奇迹。

【成就解锁：团结的力量】""",
        35: """═══════════════════════════════════════
掩体结局：分散的希望
═══════════════════════════════════════

人类没有完全团结，
但也没有完全分裂。

一些人逃离了，一些人留下了。
一些人选择战斗，一些人选择接受。

人类文明以不同的形式延续着。

这是一个现实的结局。
不完美，但这就是人类。

【成就解锁：人类的多样性】""",
        # 黑暗纪元结局
        "dark_slavery": """═══════════════════════════════════════
结局：永久奴役
═══════════════════════════════════════

人类放弃了抵抗。

在澳洲保留区，30亿人像牲畜一样被圈养。
每天的配给只够勉强活命。

三体人承诺："只要服从，就能生存。"

一代又一代，人类逐渐忘记了自由的滋味。
孩子们从出生就生活在铁丝网内。
他们不知道地球曾经属于人类。

一千年后，人类成为了三体文明的附庸种族。
地球历史被改写，人类文明被遗忘。

这就是黑暗的永恒。

【成就解锁：永恒的奴隶】""",
        
        "dark_reservation": """═══════════════════════════════════════
结局：人类保留区
═══════════════════════════════════════

你选择了放弃抵抗。

在澳洲，人类建立了"新秩序"：
- 与三体人合作
- 接受配给制度
- 放弃科技发展
- 服从智子监控

三体人满意地点头："这才是明智的选择。"

人类保留了生存权，但失去了一切。
没有自由，没有尊严，没有未来。

只有苟延残喘。

【成就解锁：苟且偷生】""",
        
        "dark_underground_extinction": """═══════════════════════════════════════
结局：地下灭绝
═══════════════════════════════════════

地下资源耗尽了。

人工光源熄灭，农场枯萎。
氧气循环系统故障，空气变得稀薄。
地下城市陷入黑暗和混乱。

人类在地下互相残杀，争夺最后的食物。

三体人在地表冷眼旁观：
"他们自己解决了问题。"

最后一个人类在黑暗中死去。
地下世界成为巨大的坟墓。

【成就解锁：地下墓穴】""",
        
        # 流浪纪元结局
        "wanderer_new_home": """═══════════════════════════════════════
结局：新人类文明
═══════════════════════════════════════

舰队抵达了新的星系。

这里有适合人类居住的行星。
100万幸存者在这里重建文明。

他们吸取了地球的教训：
- 不再盲目扩张
- 保持对宇宙的敬畏
- 珍惜和平

新文明在星空下诞生。

程心在新地球上种下第一棵树：
"这是新的开始。"

【成就解锁：新世界】""",
        
        "wanderer_guerrilla": """═══════════════════════════════════════
结局：星际游击队
═══════════════════════════════════════

舰队没有停下。

他们在星际间游荡，
不断骚扰三体的殖民地，
破坏三体的补给线。

人类成为了宇宙中的游击队。

维德的遗言成为座右铭：
"只要还有一个人类活着，
抵抗就不会停止！"

【成就解锁：永恒的抵抗】""",
        
        "wanderer_revenge": """═══════════════════════════════════════
结局：复仇之战
═══════════════════════════════════════

一百年后，舰队返回太阳系。

他们带回了强大的技术和盟友。

地球光复战争打响！

三体人被驱逐，地球重获自由。

罗辑的雕像矗立在天安门广场：
"我们回来了。"

【成就解锁：复仇成功】""",
        
        "wanderer_guilt": """═══════════════════════════════════════
结局：精英的原罪
═══════════════════════════════════════

舰队抵达新星球。

但船上的人永远无法忘记：
他们是踩着同胞的尸体逃走的。

这份原罪，伴随他们一生。

新文明建立了"忏悔日"：
每年这一天，所有人默哀，
纪念那些被抛弃的29.9亿人。

【成就解锁：永恒的愧疚】""",
        
        "wanderer_redemption": """═══════════════════════════════════════
结局：理想新世界
═══════════════════════════════════════

舰队抵达新星球。

幸存者发誓：
"我们要建立一个更好的文明，
一个不会抛弃任何人的文明。"

新文明实现了真正的平等和公正。

程心的遗言被刻在纪念碑上：
"让那些牺牲有意义。"

【成就解锁：救赎之路】""",
        
        # 解放纪元结局
        "liberation_peace": """═══════════════════════════════════════
结局：短暂的和平
═══════════════════════════════════════

你选择无视威胁，专注重建。

人类享受了五十年的和平。

但最终，未知文明的舰队抵达。

人类毫无准备，被轻易摧毁。

罗辑的警告成为现实：
"黑暗森林法则，永远有效。"

【成就解锁：和平的代价】""",
        
        "liberation_diplomacy": """═══════════════════════════════════════
结局：新的奴役
═══════════════════════════════════════

你选择谈判。

未知文明同意不摧毁人类，
但条件是：人类必须成为他们的附庸。

人类刚刚摆脱三体的奴役，
又陷入了新的奴役。

宇宙，永远是弱肉强食。

【成就解锁：永恒的奴役】""",
        
        "liberation_yun": """═══════════════════════════════════════
结局：云天明的礼物
═══════════════════════════════════════

舰队找到了云天明。

他带回了一个秘密：
一种可以对抗任何文明的终极武器。

人类获得了真正的安全。

程心和云天明终于重逢：
"我一直在等你。"

【成就解锁：爱的奇迹】""",
        
        "liberation_explore": """═══════════════════════════════════════
结局：星际探索者
═══════════════════════════════════════

人类成为了宇宙的探索者。

他们不断发现新的星系，
结识新的文明，
学习新的知识。

人类文明在探索中不断进化。

【成就解锁：永恒的探索】""",
        
        # 地下纪元结局
        "underground_kingdom": """═══════════════════════════════════════
结局：地下王国
═══════════════════════════════════════

人类在地下建立了永久的文明。

三百年后，新一代人类完全适应了地下生活。

他们创造了独特的地下文化，
发展了独立的科技体系。

地下，成为了人类真正的家园。

【成就解锁：地下王国】""",
        
        "underground_core": """═══════════════════════════════════════
结局：地心文明（隐藏）
═══════════════════════════════════════

你选择继续挖掘。

在地下10000米处，
人类发现了一个巨大的空间。

那里有史前文明的遗迹，
还有无尽的能源和资源。

人类在地心建立了新文明。

这是一个隐藏的结局。
地心，成为人类最安全的避难所。

【成就解锁：地心秘密】""",
        
        "underground_fear": """═══════════════════════════════════════
结局：未知的恐惧
═══════════════════════════════════════

你选择停止挖掘。

但那个地下5000米的秘密，
永远成为人类的噩梦。

地心深处，到底有什么？

没人知道。

也许，不知道才是最好的。

【成就解锁：未知的恐惧】""",
    }
    text = ending_texts.get(num, "未知结局")
    text += f"\n\n你的属性:\n"
    text += f"生存意志: {game.score['survival']}\n"
    text += f"科技发展: {game.score['technology']}\n"
    text += f"道德水平: {game.score['morality']}\n"
    text += f"侵略性: {game.score['aggression']}\n"
    text += f"团结度: {game.score['unity']}\n"
    text += f"\n经历纪元: {' → '.join(game.era_path)}"
    game.show_text(text)
    game.add_button("重新开始", game.restart_game)
    game.add_button("退出游戏", game.root.quit)
    text += f"生存意志: {game.score['survival']}\n"
    text += f"科技发展: {game.score['technology']}\n"
    text += f"道德水平: {game.score['morality']}\n"
    text += f"侵略性: {game.score['aggression']}\n"
    text += f"团结度: {game.score['unity']}\n"
    text += f"\n经历纪元: {' → '.join(game.era_path)}"
    game.show_text(text)
    game.add_button("重新开始", game.restart_game)
    game.add_button("退出游戏", game.root.quit)

def restart_game(game):
    game.score = {'survival': 0, 'technology': 0, 'morality': 0, 'aggression': 0, 'unity': 0}
    game.era_path = []
    game.start_game()

