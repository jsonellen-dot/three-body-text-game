"""
黑暗纪元模块
威慑失败后的四条分支路线
"""

def dark_era_1(game):
    """黑暗纪元：威慑崩溃"""
    game.clear_buttons()
    game.show_text("""═══════════════════════════════════════
    黑暗纪元：威慑崩溃
═══════════════════════════════════════

公元2270年，程心成为执剑人。

她接过罗辑手中的开关，那个可以毁灭两个世界的按钮。

罗辑苍老的声音回荡在交接仪式上：
"记住，威慑的关键不是能力，而是意志。
三体人必须相信，你真的会按下按钮。"

但程心心中充满了爱。
她想起了云天明，想起了他送给她的那颗星星。
她相信，爱可以化解一切仇恨...

三个月后，三体舰队突然加速。

智子出现在程心面前，冷笑道：
"交出引力波发射器，否则我们将摧毁地球。
你有15分钟时间考虑。"

程心的手指放在按钮上，颤抖不止。

她想按下去，但她做不到。
她想起了三体世界的孩子们...
她想起了云天明还在三体舰队中...

15分钟后，她放下了手。

"我不能...我不能毁灭两个世界..."

威慑失败。

水滴从天而降，摧毁了所有引力波发射器。
三体舰队降落地球。

罗辑在监控室中闭上了眼睛：
"我就知道...她太善良了..."

维德愤怒地砸碎了屏幕：
"我早就说过！执剑人必须是恶魔！
现在好了，人类完了！"

人类的黄金时代结束了。
黑暗纪元开始。

你必须决定人类的命运：

1. 【撤往澳洲】组织残余力量撤往澳大利亚保留区
2. 【转入地下】放弃地表，转入地下世界生存
3. 【绝望投降】接受三体统治，不再反抗""")
    
    game.add_button("选择1", lambda: game.choice(3, 0, 0, 0, 0, dark_era_2_australia))
    game.add_button("选择2", lambda: game.choice(0, 2, 0, 0, 0, dark_era_2_underground))
    game.add_button("选择3", lambda: game.choice(-5, 0, 5, 0, 0, ending_dark_1))

def dark_era_2_australia(game):
    """黑暗纪元：澳洲保留区"""
    game.clear_buttons()
    game.show_text("""═══════════════════════════════════════
    黑暗纪元：澳洲保留区
═══════════════════════════════════════

三体人将30亿人类驱赶到澳大利亚。

智子宣布："这是人类最后的保留区。
面积770万平方公里，足够你们生存。
但你们必须服从我们的管理。"

现实是残酷的：
- 人口：30亿（全球幸存者）
- 资源：严重短缺，每天饿死数万人
- 配给：每人每天500克合成食物
- 监控：智子无处不在，任何反抗都会被发现

三体人占领了其他所有大陆。
地球的资源被疯狂开采，运往三体世界。

在悉尼废墟中，维德召集了残余的抵抗力量。

"各位，"维德的声音低沉而坚定，
"我们失去了地球，但还没有失去希望。
三体人的工厂需要人类劳工，
这是我们唯一的机会..."

AA悄悄说："我在三体工厂工作过。
他们的防御并不严密，
如果我们能潜入核心区域..."

罗辑坐在角落里，苍老的脸上露出一丝笑容：
"年轻人，黑暗森林法则还记得吗？
如果我们能重新获得威慑能力..."

程心低着头，充满愧疚：
"都是我的错...如果我当时按下了按钮..."

维德打断她："现在不是自责的时候。
我们必须行动。"

你必须选择抵抗的方向：

1. 【窃取技术】潜入三体工厂，窃取飞船技术（维德的计划）
2. 【寻找武器】重建宇宙广播器，恢复威慑（罗辑的计划）
3. 【社交博弈】与三体温和派接触，寻求合作（程心的计划）
4. 【放弃抵抗】接受现实，在保留区苟且偷生""")
    
    game.add_button("选择1", lambda: game.choice(2, 3, -1, 0, 0, dark_era_3_tech_theft))
    game.add_button("选择2", lambda: game.choice(1, 2, 0, 2, 0, dark_era_3_weapon))
    game.add_button("选择3", lambda: game.choice(0, 0, 3, 0, 2, dark_era_3_diplomacy))
    game.add_button("选择4", lambda: game.choice(-3, 0, 2, 0, 0, ending_dark_2))

def dark_era_2_underground(game):
    """黑暗纪元：转入地下"""
    game.clear_buttons()
    game.show_text("""═══════════════════════════════════════
    黑暗纪元：转入地下
═══════════════════════════════════════

地表已经不安全。

维德下达了最后的命令：
"所有人，转入地下！
这是人类文明的最后堡垒！"

在全球各地，人类开始向地下转移：

**中国：**
- 利用废弃的矿井和地铁系统
- 北京地下城：5000万人口
- 上海地下城：4000万人口

**美国：**
- 改造核掩体和地下军事基地
- 纽约地下城：3000万人口

**欧洲：**
- 在阿尔卑斯山下挖掘洞穴
- 伦敦地下城：2000万人口

**火星：**
- 殖民地转入地下
- 奥林帕斯地下城：500万人口

三体人控制地表，人类退守地下。

在北京地下城的指挥中心，罗辑看着地图：
"我们在地下建立了50个城市，
总人口20亿。
这是一个奇迹。"

AA负责地下农场："我们用LED模拟阳光，
可以种植粮食。
虽然产量不高，但能维持基本生存。"

程心负责教育系统："孩子们从未见过真正的天空，
但我们必须让他们记住，
地表曾经属于人类..."

维德负责军事："我们在地下秘密生产武器。
总有一天，我们会反攻地表！"

但资源有限，空间狭小...
人类能在地下生存多久？

你必须决定地下文明的未来：

1. 【长期坚守】在地下建立永久文明
2. 【地下反击】积蓄力量，从地下反攻地表
3. 【资源耗尽】地下资源即将耗尽，文明面临崩溃""")
    
    from .underground import underground_era_1
    game.add_button("选择1", lambda: game.choice(2, 1, 1, 0, 2, underground_era_1))
    game.add_button("选择2", lambda: game.choice(1, 1, 0, 3, 1, underground_era_2_counterattack))
    game.add_button("选择3", lambda: game.choice(-5, 0, 0, 0, 0, ending_dark_3))

def dark_era_3_tech_theft(game):
    """黑暗纪元：技术窃取"""
    game.clear_buttons()
    game.show_text("""═══════════════════════════════════════
    黑暗纪元：普罗米修斯计划
═══════════════════════════════════════

维德制定了"普罗米修斯计划"：
潜入三体工厂，窃取飞船技术。

"就像普罗米修斯盗取天火一样，"
维德在秘密会议上说，
"我们要从神那里偷回属于人类的技术。"

经过三年的准备：

**情报收集：**
- AA潜入工厂当劳工，绘制了完整地图
- 收买了三体工厂的人类监工
- 破解了部分三体通信密码

**突击队训练：**
- 100名精英特工
- 掌握三体语言和文化
- 配备最先进的潜入装备

**目标技术：**
✓ 曲率驱动引擎设计图
✓ 反物质能源技术
✓ 生命维持系统
✓ 智子屏蔽技术

行动之夜。

AA带领突击队潜入工厂核心区域。

"这里，"她指着一个终端，
"所有技术数据都在这里。"

数据开始复制...10%...30%...50%...

突然，警报响起！

智子的声音回荡在工厂中：
"检测到入侵者。启动防御系统。"

维德通过通讯器吼道：
"AA！立即撤退！"

AA看着进度条：70%...80%...

"再等一分钟！我们快成功了！"

你必须决定：

1. 【立即撤退】带着70%的数据逃离，保证人员安全
2. 【继续窃取】冒险等待100%，可能全军覆没""")
    
    from .wanderer import wanderer_era_1
    game.add_button("选择1", lambda: game.choice(2, 2, 1, 0, 0, wanderer_era_1))
    game.add_button("选择2", lambda: game.choice(0, 3, -1, 2, 0, tech_theft_gamble))

def tech_theft_gamble(game):
    """技术窃取：赌博"""
    import random
    if random.random() > 0.5:
        # 成功
        game.clear_buttons()
        game.show_text("""100%！数据复制完成！

AA抓起存储器："撤退！"

突击队冲出工厂，三体守卫紧追不舍。

激烈的枪战中，20名队员牺牲。
但剩下的人成功逃脱。

维德接过存储器，眼中闪烁着泪光：
"你们是英雄。
这些数据，将拯救人类文明。"

技术窃取成功！""")
        from .wanderer import wanderer_era_1
        game.add_button("继续", lambda: game.choice(3, 5, 0, 0, 0, wanderer_era_1))
    else:
        # 失败
        from .endings import ending
        game.clear_buttons()
        game.show_text("""90%...95%...

三体守卫冲进来了！

激光武器扫射，突击队员一个个倒下。

AA拼命保护存储器，但被击中了。

她倒在血泊中，看着存储器被三体人夺走...

"对不起...维德...我失败了..."

行动失败。
突击队全军覆没。
人类失去了最后的希望。""")
        game.add_button("查看结局", lambda: ending(game, "tech_theft_fail"))

def dark_era_3_weapon(game):
    """黑暗纪元：寻找终极武器"""
    game.clear_buttons()
    game.show_text("""═══════════════════════════════════════
    黑暗纪元：黑暗森林计划
═══════════════════════════════════════

罗辑召集了科学家团队。

"各位，"他苍老的声音依然坚定，
"我们可以重建威慑。"

科学家们面面相觑："怎么做？
引力波发射器都被摧毁了。"

罗辑在黑板上写下一个公式：
"我们可以制造'宇宙广播器'。
向全宇宙广播三体世界的坐标。

这样，三体人就会被其他文明摧毁。
我们重新获得威慑能力！"

程心震惊："但这会暴露地球的位置！"

罗辑冷笑："我们已经没有选择了。
要么威慑三体，要么永远做奴隶。"

维德点头："我支持这个计划。
需要什么资源，我来搞定。"

**计划需求：**
- 大量能源（需要窃取三体的反物质）
- 精密设备（需要潜入三体实验室）
- 时间（至少3年）
- 风险（可能被发现，导致全面镇压）

AA负责情报："我可以潜入实验室。"

程心犹豫："这太危险了...
而且，广播坐标会害死无辜的三体人..."

罗辑看着她："程心，你还没明白吗？
宇宙就是黑暗森林。
仁慈，只会导致灭亡。"

你必须决定：

1. 【执行计划】不惜一切代价制造广播器
2. 【放弃计划】风险太大，寻找其他办法""")
    
    from .liberation import liberation_era_1
    game.add_button("选择1", lambda: game.choice(2, 3, -2, 3, 0, liberation_era_1))
    game.add_button("选择2", lambda: game.choice(0, 0, 2, 0, 1, dark_era_3_diplomacy))

def dark_era_3_diplomacy(game):
    """黑暗纪元：社交博弈"""
    game.clear_buttons()
    game.show_text("""═══════════════════════════════════════
    黑暗纪元：和平派的秘密
═══════════════════════════════════════

程心一直相信，三体人中也有善良的个体。

她的信念得到了验证。

一天夜里，智子秘密来访。

"程心，"智子的声音不再冰冷，
"我有话要对你说。"

程心警惕地看着她："你想干什么？"

智子叹息："三体文明内部并非铁板一块。
有一派（我们称之为'和平派'）认为，
殖民地球是错误的。"

"我们应该与人类共存，而非奴役。
但战争派掌握着权力。"

程心震惊："你是和平派？"

智子点头："我是三体派到地球的AI，
但我在地球生活了几十年，
我爱上了这个星球，爱上了人类文化。"

"我可以帮你们，但需要筹码。
如果你们能证明人类值得尊重，
我会说服三体议会给予你们自治权。"

维德冷笑："这可能是陷阱。"

罗辑沉思："也可能是真的。
三体文明经历了200多次毁灭和重生，
内部分裂很正常。"

AA说："我们可以试试。
反正现在也没有更好的办法。"

智子说："我需要你们展示：
- 人类的文化价值
- 科技创新能力
- 和平共处的诚意

如果你们能打动三体议会，
和平派就有机会推翻战争派。"

程心眼中燃起希望："我愿意试试！"

你必须决定：

1. 【展示价值】向三体展示人类文化和科技
2. 【不信任】这可能是陷阱，拒绝合作""")
    
    from .liberation import liberation_era_1
    game.add_button("选择1", lambda: game.choice(0, 2, 3, 0, 2, liberation_era_1))
    game.add_button("选择2", lambda: game.choice(1, 0, 0, 1, 0, dark_era_2_australia))

def underground_era_2_counterattack(game):
    """地下纪元：地下反击"""
    game.clear_buttons()
    game.show_text("""═══════════════════════════════════════
    地下纪元：地下反击
═══════════════════════════════════════

"我们不能永远躲在地下！"

维德在地下指挥中心召开战争会议。

"各位，经过五年的准备，
我们已经在地下秘密生产了足够的武器。
是时候反攻了！"

罗辑看着作战地图：
"我们可以从地铁隧道突然出现，
三体人不会想到我们从地下进攻。"

AA负责情报："三体人在地表的兵力不多，
他们太自信了，认为人类已经被彻底压制。"

程心担忧："但我们的武器能对抗三体科技吗？"

维德冷笑："我们窃取了部分三体技术，
改进了我们的武器。
虽然还有差距，但足够打一场游击战。"

行动开始！

**北京战役：**
- 从地铁隧道涌出10万抵抗军
- 夺回天安门广场
- 三体守卫措手不及

**上海战役：**
- 从黄浦江地下突袭
- 夺回外滩和浦东
- 摧毁三体补给站

**纽约战役：**
- 从下水道系统进攻
- 夺回曼哈顿
- 炸毁三体通讯塔

**伦敦战役：**
- 从地铁突袭
- 夺回白金汉宫
- 建立临时政府

人类夺回了部分地表城市！

但三体舰队正在集结...

智子冷冷地说：
"人类，你们的反抗毫无意义。
我们的舰队将在三天后抵达。
到时候，你们将被彻底消灭。"

你必须决定：

1. 【坚守城市】死守夺回的领土，与三体决战
2. 【撤回地下】保存实力，继续打持久战""")
    
    from .underground import underground_era_3_defense
    game.add_button("选择1", lambda: game.choice(1, 0, 2, 3, 1, underground_era_3_defense))
    from .underground import underground_era_3_guerrilla
    game.add_button("选择2", lambda: game.choice(2, 1, 0, 1, 2, underground_era_3_guerrilla))

# 黑暗结局
def ending_dark_1(game):
    """结局：永久奴役"""
    from .endings import ending
    ending(game, "dark_slavery")

def ending_dark_2(game):
    """结局：人类保留区"""
    from .endings import ending
    ending(game, "dark_reservation")

def ending_dark_3(game):
    """结局：地下灭绝"""
    from .endings import ending
    ending(game, "dark_underground_extinction")
